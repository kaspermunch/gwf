<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Documentation</title>
    <meta name="description" content="A small utility for specifying and running computation workflows on computer clusters.
">

    <link rel="stylesheet" href="/gwf//css/main.css">
    <link rel="canonical" href="http://mailund.github.io/gwf//documentation/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/gwf//">GWF - Grid WorkFlow</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/gwf//about/">About</a>
          
        
          
          <a class="page-link" href="/gwf//documentation/">Documentation</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>


  </div>

</header>



    <div class="page-content">

      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Documentation</h1>
  </header>

  <article class="post-content">
    <p>Using GWF involves specifying a workflow in one or more files and using the <code>gwf</code> script to submit jobs in the workflow to the computer cluser.</p>

<p>Workflows are specified in Python using a special function, <code>target()</code>, that specifies a job to be run. Targets depend on zero or more input files and produce zero or more output files. If any input file is younger than any output file then the target is assumed to be out of date and <code>gwf</code> will recognize this.</p>

<p>When you run <code>gwf</code> in a directory with a workflow specified in a file named <code>workflow.py</code> it will figure out which targets needs to be run and schedule them on the cluster. If there are dependencies between the jobs it will schedule them in such a way that a target is only run after all the targets that it depends on have run. If a target is already submitted to the cluster when you run <code>gwf</code> it will not be submitted again, but any other job that depends on it will be set to wait for its completion before it can run.</p>

<p>At any time, you can use <code>gwf --status</code> to see the status of your workflow. This will show how many targets are up to date, how many are currently running or queued on the cluster, and how many targets still needs to be submitted.</p>

<p>By default, <code>gwf --status</code> will only show the status of terminal targets, i.e. targets that no other target depends on. To see other targets, simply run <code>gwf --status TARGET_NAME</code>.</p>

<p>Run <code>gwf --help</code> to get a list of options for <code>gwf</code>.</p>

<p>For ways of configuring GWF run <code>gwf-config --help</code>.</p>

<h1 id="specifying-workflows">Specifying workflows</h1>

<p>Workflows are specified in Python. Having a full blown programming language to specify workflows makes GWF very powerful, but simple workflows can still be specified with very simple syntax.</p>

<p>Below is a very simple workflow with a single target that just unzips a file.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">gwf</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">target</span><span class="p">(</span><span class="s">&#39;UnZipGenome&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="s">&#39;ponAbe2.fa.gz&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s">&#39;ponAbe2.fa&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">gzcat ponAbe2.fa.gz &gt; ponAbe2.fa</span>
<span class="s">&#39;&#39;&#39;</span></code></pre></div>

<p>The first line is necessary to import the <code>target()</code> function. </p>

<p>The call to the <code>target()</code> function takes three parameters. The first is always the name of the target – which should be unique for the workflow – and any other parameters should be named parameters. These parameters will specify the input and output files for the target and any options that should be passed on to the cluster such as the necessary resources for executing the target.</p>

<p>In the example above, only the input and output files are specified. There is one input file, <code>ponAbe2.fa.gz</code>, and one output file <code>ponAbe2.fa</code>. When more input or output files are needed these are simply specified as a Python list.</p>

<p>The actual execution for the target is specified outside the call to the function, in the string that follows the <code>&lt;&lt;</code> operator. The string that follows the operator should contain the shell commands that the target should execute. In the example there is a single command that uses <code>gzcat</code> to unzip a FASTA file.</p>

<p>To string together a number of tasks, a workflow simply needs to specify more than one target. The dependencies between targets are then determined by the input and output files. For a slightly more complex example, see below:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">gwf</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">target</span><span class="p">(</span><span class="s">&#39;UnZipGenome&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="s">&#39;ponAbe2.fa.gz&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s">&#39;ponAbe2.fa&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">gzcat ponAbe2.fa.gz &gt; ponAbe2.fa</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">target</span><span class="p">(</span><span class="s">&#39;IndexGenome&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="s">&#39;ponAbe2.fa&#39;</span><span class="p">,</span>
       <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;ponAbe2.amb&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.ann&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.pac&#39;</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">bwa index -p ponAbe2 -a bwtsw ponAbe2.fa</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">target</span><span class="p">(</span><span class="s">&#39;MapReads&#39;</span><span class="p">,</span> 
       <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;ponAbe2.fa&#39;</span><span class="p">,</span> 
              <span class="s">&#39;ponAbe2.amb&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.ann&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.pac&#39;</span><span class="p">,</span>
              <span class="s">&#39;Masala_R1.fastq.gz&#39;</span><span class="p">,</span> <span class="s">&#39;Masala_R2.fastq.gz&#39;</span><span class="p">],</span>
       <span class="n">output</span><span class="o">=</span><span class="s">&#39;Masala.sorted.rmdup.bam&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">bwa mem -t 16 ponAbe2.fa Masala_R1.fastq.gz Masala_R2.fastq.gz | </span><span class="se">\</span>
<span class="s">    samtools view -Shb - &gt; /scratch/$GWF_JOBID/unsorted.bam</span>

<span class="s">samtools sort -o /scratch/$GWF_JOBID/unsorted.bam /scratch/$GWF_JOBID/sort | </span><span class="se">\</span>
<span class="s">    samtools rmdup -s - Masala.sorted.rmdup.bam</span>
<span class="s">&#39;&#39;&#39;</span></code></pre></div>

<p>This workflow has three targets: <code>UnZipGenome</code>, <code>IndexGenome</code>, and <code>MapReads</code>. The output file from <code>UnZipGenome</code>, <code>ponAbe2.fa</code>, is used as the input for <code>IndexGenome</code> that in turn produces three index files as output, <code>ponAbe2.amb</code>, <code>ponAbe2.ann</code>, and <code>ponAbe2.pac</code>. Both the FASTA file and the three index files are input files to the <code>MapReads</code> target in addition to two FASTQ files. The <code>MapReads</code> target executes two shell commands – any number is allows in a target specification – to produce the final output.</p>

<p>In this workflow, <code>UnZipGenome</code> and <code>IndexGenome</code> both have other targets depending on them, so <code>MapReads</code> is the only terminal target and <code>gwf --status</code> would only show the progress in computing the final output file.</p>

<h2 id="target-options">Target options</h2>

<p>Additional named options to the <code>target()</code> function can be used to set the resources needed to run the target.</p>

<p>Four options are currently recognized:</p>

<ul>
  <li><code>nodes</code> – The number of computer nodes needed for the target. The default is 1.</li>
  <li><code>cores</code> – The number of cores (per node). The default is 1.</li>
  <li><code>memory</code> – The necessary RAM. This can be specified either in bytes as an integer or as a string in the usual format like “2g” for 2 gigabytes. The default is “4g”.</li>
  <li><code>walltime</code> – The time needed to finish the job. Specified as a string in the “hh:mm:ss” format. The default is “120:00:00”.</li>
</ul>

<p>In the example above, the <code>MapReads</code> target asks <code>bwa</code> to use 16 threads for read-mapping so this target should ask for 16 cores:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">target</span><span class="p">(</span><span class="s">&#39;MapReads&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;ponAbe2.fa&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;ponAbe2.amb&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.ann&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.pac&#39;</span><span class="p">,</span>
                          <span class="s">&#39;Masala_R1.fastq.gz&#39;</span><span class="p">,</span> <span class="s">&#39;Masala_R2.fastq.gz&#39;</span><span class="p">],</span>
       <span class="n">output</span><span class="o">=</span><span class="s">&#39;Masala.sorted.rmdup.bam&#39;</span><span class="p">,</span>
       <span class="n">cores</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">bwa mem -t 16 ponAbe2.fa Masala_R1.fastq.gz Masala_R2.fastq.gz | </span><span class="se">\</span>
<span class="s">    samtools view -Shb - &gt; /scratch/$GWF_JOBID/unsorted.bam</span>

<span class="s">samtools sort -o /scratch/$GWF_JOBID/unsorted.bam /scratch/$GWF_JOBID/sort | </span><span class="se">\</span>
<span class="s">    samtools rmdup -s - Masala.sorted.rmdup.bam</span>
<span class="s">&#39;&#39;&#39;</span></code></pre></div>

<h2 id="helper-functions-in-the-gwf-module">Helper functions in the gwf module</h2>

<p>When importing the <code>gwf</code> Python module you also import two helper functions that are useful for working with files: <code>glob</code> and <code>shell</code>.  The first identifies files using <a href="http://en.wikipedia.org/wiki/Glob_(programming)">shell expansion</a> and returns a Python list of the matched files while the second executes a shell command and returns the result as a list of tokens.</p>

<p>The two commands below will thus both return a list of the files in current directory:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">gwf</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">)</span>
<span class="n">the_same_files</span> <span class="o">=</span> <span class="n">shell</span><span class="p">(</span><span class="s">&quot;ls&quot;</span><span class="p">)</span></code></pre></div>

<h1 id="templates">Templates</h1>

<p>Building every target as in the examples above only works when there are a few targets and when the targets are known at the time the workflow is written. Very often there is a large number of targets and often the exact number of targets depend on the data to be analysed.</p>

<p>When this is the case, we can use more Python programming to create the targets.</p>

<p>If, for example, we have several pairs of FASTQ files and want to map them to a set of BAM files, we can iterate over them and build targets for each BAM file.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">gwf</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">R1files</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Masala_1_R1.fastq.gz&#39;</span><span class="p">,</span> <span class="s">&#39;Masala_2_R1.fastq.gz&#39;</span><span class="p">]</span>
<span class="n">R2files</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Masala_1_R2.fastq.gz&#39;</span><span class="p">,</span> <span class="s">&#39;Masala_2_R2.fastq.gz&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">R1files</span><span class="p">)):</span>
  <span class="n">target</span><span class="p">(</span><span class="s">&#39;MapRead_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
         <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;ponAbe2.fa&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.amb&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.ann&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.pac&#39;</span><span class="p">,</span>
                <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">],</span>
         <span class="n">output</span><span class="o">=</span><span class="s">&#39;Masala_{}.sorted.rmdup.bam&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
         <span class="n">cores</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">  bwa mem -t 16 ponAbe2.fa {r1} {r2} | </span><span class="se">\</span>
<span class="s">      samtools view -Shb - &gt; /scratch/$GWF_JOBID/unsorted.bam</span>

<span class="s">  samtools sort -o /scratch/$GWF_JOBID/unsorted.bam /scratch/$GWF_JOBID/sort | </span><span class="se">\</span>
<span class="s">      samtools rmdup -s - Masala_{number}.sorted.rmdup.bam</span>
<span class="s">  &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r1</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span></code></pre></div>

<p>This looks a lot more complicated – and using templates as described below it can be much simplified – but we can break it down a bit to see what is going on.</p>

<p>First, we see the paired-end FASTQ files in two different lists.</p>

<p>When there are many such files, we can build the lists using functions like <code>glob</code> or collect them some other way, but here they are just shown explicitly for the example.</p>

<p>Using the Python function <code>zip</code> we match them up as pairs and combined with <code>enumerate</code> we get each pair together with a number. Here it will be 0 and 1 since those are the numbers <code>enumerate</code> will give. So the line</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">R1files</span><span class="p">)):</span></code></pre></div>

<p>will loop over the pairs and give each a number.</p>

<p>The number is assigned to the variable <code>i</code> and the two FASTQ files are assigned to the variables <code>r1</code> and <code>r2</code>.</p>

<p>The number is used to make a unique target name for each pair using the <a href="https://docs.python.org/2/library/string.html#format-string-syntax">format</a> string method.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">target</span><span class="p">(</span><span class="s">&#39;MapRead_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span></code></pre></div>

<p>We are adding one to make the targets numbered from 1 rather than zero. We didn’t have to, but it matches the way we have numbered the input files better.</p>

<p>The two FASTQ files in the pair are used in the list of input files</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;ponAbe2.fa&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.amb&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.ann&#39;</span><span class="p">,</span> <span class="s">&#39;ponAbe2.pac&#39;</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">],</span></code></pre></div>

<p>and the number again to specify the output file</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">output</span><span class="o">=</span><span class="s">&#39;Masala_{}.sorted.rmdup.bam&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span></code></pre></div>

<p>and all three variables are used when specifying the shell commands for the target, again using <a href="https://docs.python.org/2/library/string.html#format-string-syntax">format</a>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r1</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span></code></pre></div>

<p>In this case with named parameters to make the subsitutions more explicit.</p>

<h2 id="templates-1">Templates</h2>

<p>There is a lot of explicit text substitution going on in the example above, but we can hide that away to some extend using a template mechanism.</p>

<p>Under the hood, it is still just <a href="https://docs.python.org/2/library/string.html#format-string-syntax">format text substitution</a> going on but in many cases we don’t want to clutter up the workflow with this and we can in fact hide it away a bit.</p>

<p>The simplest way to do this is using the <code>template</code> function. This function uses a mix of <code>target</code> and <a href="https://docs.python.org/2/library/string.html#format-string-syntax">format</a> functionality to achive this.</p>

<p>The function takes the same named parameter as the <code>target</code> function – <code>input</code> and <code>output</code> plus the resource options for the grid backend – but you can write template parameters in them using curly brackets like for <a href="https://docs.python.org/2/library/string.html#format-string-syntax">format</a>.</p>

<p>As a first example we can take the <code>IndexGenome</code> from earlier and make a template for it:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">bwa_index</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s">&#39;{refGenome}.fa&#39;</span><span class="p">,</span> 
                     <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;{refGenome}.amb&#39;</span><span class="p">,</span> 
                             <span class="s">&#39;{refGenome}.ann&#39;</span><span class="p">,</span> 
                             <span class="s">&#39;{refGenome}.pac&#39;</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">bwa index -p {refGenome} -a bwtsw {refGenome}.fa</span>
<span class="s">&#39;&#39;&#39;</span></code></pre></div>

<p>It looks a lot like the target from earlier but has the <em>magic</em> variable <code>{refGenome}</code> in it.</p>

<p>This template specification creates a function, <code>bwa_index</code>, that you can later use to define targets. The curly bracket variable becomes a (named) parameter of this function, so when you use it like</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">target</span><span class="p">(</span><span class="s">&#39;IndexGenome&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bwa_index</span><span class="p">(</span><span class="n">refGenome</span><span class="o">=</span><span class="s">&#39;ponAbe2&#39;</span><span class="p">)</span></code></pre></div>

<p>the <code>{refGenome}</code> text in both the named parameters and the shell script specification gets assigned the value you set <code>refGenome</code> to in the call of the function, i.e. “ponAbe2”.</p>

<p>All the parameters plus the shell script is just passed along to the target, so using the template in this way does exactly the same as the <code>IndexGenome</code> target from earlier, just with the shell commands and file names hidden away in the template specification.</p>

<p>Only slightly more complex is the template specification for the read-mapping:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">bwa_map</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;{R1}&#39;</span><span class="p">,</span> <span class="s">&#39;{R2}&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.amb&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.ann&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.pac&#39;</span><span class="p">],</span>
                   <span class="n">output</span><span class="o">=</span><span class="s">&#39;{bamfile}&#39;</span><span class="p">,</span>
                   <span class="n">cores</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">bwa mem -t 16 {refGenome} {R1} {R2} | </span><span class="se">\</span>
<span class="s">    samtools view -Shb - &gt; /scratch/$GWF_JOBID/unsorted.bam</span>

<span class="s">samtools sort -o /scratch/$GWF_JOBID/unsorted.bam /scratch/$GWF_JOBID/sort | </span><span class="se">\</span>
<span class="s">    samtools rmdup -s - {bamfile}</span>

<span class="s">&#39;&#39;&#39;</span></code></pre></div>

<p>This template has four curly bracket parameters, <code>R1</code>, <code>R2</code>, <code>refGenome</code>, and <code>bamfile</code> but otherwise works the same way as the <code>bwa_index</code> template. When called to make a target you just need to specify four parameters instead of one, so the <code>MapReads</code> target from earlier would simply be</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">target</span><span class="p">(</span><span class="s">&#39;MapReads&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bwa_map</span><span class="p">(</span><span class="n">R1</span><span class="o">=</span><span class="s">&#39;Masala_R1.fastq.gz&#39;</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="s">&#39;Masala_R2.fastq.gz&#39;</span><span class="p">,</span>
                              <span class="n">refGenome</span><span class="o">=</span><span class="s">&#39;ponAbe2&#39;</span><span class="p">,</span> 
                              <span class="n">bamfile</span><span class="o">=</span><span class="s">&#39;Masala.sorted.rmdup.bam&#39;</span><span class="p">)</span></code></pre></div>

<p>and since the <code>cores</code> parameter is specified in the template this is passed on to the target, ensuring that our use of 16 cores in the <code>bwa</code> shell command matches the number of cores we ask for in the submission to the cluster.</p>

<p>You can now separate the templates from the workflow like this</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">gwf</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># Templates</span>
<span class="n">unzip</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s">&#39;{refGenome}.fa.gz&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s">&#39;{refGenome}.fa&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">gzcat {refGenome}.fa.gz &gt; {refGenome}.fa</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">bwa_index</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s">&#39;{refGenome}.fa&#39;</span><span class="p">,</span> 
                     <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;{refGenome}.amb&#39;</span><span class="p">,</span> 
                             <span class="s">&#39;{refGenome}.ann&#39;</span><span class="p">,</span> 
                             <span class="s">&#39;{refGenome}.pac&#39;</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">bwa index -p {refGenome} -a bwtsw {refGenome}.fa</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">bwa_map</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;{R1}&#39;</span><span class="p">,</span> <span class="s">&#39;{R2}&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.amb&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.ann&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.pac&#39;</span><span class="p">],</span>
                   <span class="n">output</span><span class="o">=</span><span class="s">&#39;{bamfile}&#39;</span><span class="p">,</span>
                   <span class="n">cores</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">bwa mem -t 16 {refGenome} {R1} {R2} | </span><span class="se">\</span>
<span class="s">    samtools view -Shb - &gt; /scratch/$GWF_JOBID/unsorted.bam</span>

<span class="s">samtools sort -o /scratch/$GWF_JOBID/unsorted.bam /scratch/$GWF_JOBID/sort | </span><span class="se">\</span>
<span class="s">    samtools rmdup -s - {bamfile}</span>

<span class="s">&#39;&#39;&#39;</span>

<span class="c"># Workflow</span>
<span class="n">target</span><span class="p">(</span><span class="s">&#39;UnZipGenome&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">unzip</span><span class="p">(</span><span class="n">refGenome</span><span class="o">=</span><span class="s">&#39;ponAbe2&#39;</span><span class="p">)</span>
<span class="n">target</span><span class="p">(</span><span class="s">&#39;IndexGenome&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bwa_index</span><span class="p">(</span><span class="n">refGenome</span><span class="o">=</span><span class="s">&#39;ponAbe2&#39;</span><span class="p">)</span>
<span class="n">target</span><span class="p">(</span><span class="s">&#39;MapReads&#39;</span><span class="p">)</span>    <span class="o">&lt;&lt;</span> <span class="n">bwa_map</span><span class="p">(</span><span class="n">R1</span><span class="o">=</span><span class="s">&#39;Masala_R1.fastq.gz&#39;</span><span class="p">,</span> 
                                 <span class="n">R2</span><span class="o">=</span><span class="s">&#39;Masala_R2.fastq.gz&#39;</span><span class="p">,</span>
                                 <span class="n">refGenome</span><span class="o">=</span><span class="s">&#39;ponAbe2&#39;</span><span class="p">,</span> 
                                 <span class="n">bamfile</span><span class="o">=</span><span class="s">&#39;Masala.sorted.rmdup.bam&#39;</span><span class="p">)</span></code></pre></div>

<p>Better yet, put the templates in a separate file and use Python’s module mechanism.</p>

<p>If you put the templates in a file <code>templates.py</code> next to the <code>workflow.py</code> file</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">gwf</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># Templates</span>
<span class="n">unzip</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s">&#39;{refGenome}.fa.gz&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s">&#39;{refGenome}.fa&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">gzcat {refGenome}.fa.gz &gt; {refGenome}.fa</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">bwa_index</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s">&#39;{refGenome}.fa&#39;</span><span class="p">,</span> 
                     <span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;{refGenome}.amb&#39;</span><span class="p">,</span> 
                             <span class="s">&#39;{refGenome}.ann&#39;</span><span class="p">,</span> 
                             <span class="s">&#39;{refGenome}.pac&#39;</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">bwa index -p {refGenome} -a bwtsw {refGenome}.fa</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">bwa_map</span> <span class="o">=</span> <span class="n">template</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;{R1}&#39;</span><span class="p">,</span> <span class="s">&#39;{R2}&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.amb&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.ann&#39;</span><span class="p">,</span> 
                          <span class="s">&#39;{refGenome}.pac&#39;</span><span class="p">],</span>
                   <span class="n">output</span><span class="o">=</span><span class="s">&#39;{bamfile}&#39;</span><span class="p">,</span>
                   <span class="n">cores</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#39;&#39;&#39;</span>

<span class="s">bwa mem -t 16 {refGenome} {R1} {R2} | </span><span class="se">\</span>
<span class="s">    samtools view -Shb - &gt; /scratch/$GWF_JOBID/unsorted.bam</span>

<span class="s">samtools sort -o /scratch/$GWF_JOBID/unsorted.bam /scratch/$GWF_JOBID/sort | </span><span class="se">\</span>
<span class="s">    samtools rmdup -s - {bamfile}</span>

<span class="s">&#39;&#39;&#39;</span></code></pre></div>

<p>your workflow can look as simple as</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">gwf</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">tempates</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">target</span><span class="p">(</span><span class="s">&#39;UnZipGenome&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">unzip</span><span class="p">(</span><span class="n">refGenome</span><span class="o">=</span><span class="s">&#39;ponAbe2&#39;</span><span class="p">)</span>
<span class="n">target</span><span class="p">(</span><span class="s">&#39;IndexGenome&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bwa_index</span><span class="p">(</span><span class="n">refGenome</span><span class="o">=</span><span class="s">&#39;ponAbe2&#39;</span><span class="p">)</span>
<span class="n">target</span><span class="p">(</span><span class="s">&#39;MapReads&#39;</span><span class="p">)</span>    <span class="o">&lt;&lt;</span> <span class="n">bwa_map</span><span class="p">(</span><span class="n">R1</span><span class="o">=</span><span class="s">&#39;Masala_R1.fastq.gz&#39;</span><span class="p">,</span> 
                                 <span class="n">R2</span><span class="o">=</span><span class="s">&#39;Masala_R2.fastq.gz&#39;</span><span class="p">,</span>
                                 <span class="n">refGenome</span><span class="o">=</span><span class="s">&#39;ponAbe2&#39;</span><span class="p">,</span> 
                                 <span class="n">bamfile</span><span class="o">=</span><span class="s">&#39;Masala.sorted.rmdup.bam&#39;</span><span class="p">)</span></code></pre></div>

<p>By putting your templates in python modules like this you can build libraries of useful commands that you can reuse in your workflows.</p>

<h2 id="overwriting-options-in-targets">Overwriting options in targets</h2>

<p>The resource options you specify in templates can be overwritten by explicitly setting them in targets, so if for example you have a template <code>my_cool_template</code> that sets the memory requirement to “2g” but on one particular set of data “4g” is needed you can overwrite the template default by explicitly setting the <code>memory</code> option in the target like this:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">target</span><span class="p">(</span><span class="s">&#39;myHeavyTarget&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="s">&#39;4g&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">my_cool_template</span><span class="p">()</span></code></pre></div>

<h2 id="using-functions-to-make-templates">Using functions to make templates</h2>

<p><strong>FIXME</strong></p>


  </article>

</div>

      </div>
    </div>

    
      <div class="wrapper_buttons">
          <a href="https://github.com/mailund/gwf/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/mailund/gwf/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/mailund/gwf" class="btn">View on GitHub
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span></a>
      </div>

<footer class="site-footer">


  <div class="wrapper">

    <h2 class="footer-heading">GWF - Grid WorkFlow
    </h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>GWF - Grid WorkFlow</li>
          <li><a href="mailto:mailund@birc.au.dk">mailund@birc.au.dk</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mailund">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">mailund</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/ThomasMailund">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">ThomasMailund</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">A small utility for specifying and running computation workflows on computer clusters.
</p>
      </div>
    </div>


  </div>

</footer>


  </body>

</html>
